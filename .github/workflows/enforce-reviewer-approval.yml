name: Enforce All Tagged Reviewers' Approval

on:
  pull_request:
    types:
      - closed  # Runs when PR is merged
      - review_requested  # Runs when a reviewer is assigned
      - review_request_removed  # Runs when a reviewer is removed
  pull_request_review:
    types:
      - submitted  # Runs when a review is submitted
      - dismissed  # Runs when a review is dismissed (to re-run the check)

jobs:
  check-reviewers:
    if: github.event.pull_request.merged == true  # Only run on merged PRs
    runs-on: ubuntu-latest

    steps:
      - name: Check required reviewer approvals
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"
          
          # Get the list of requested reviewers (users, not teams)
          REQUESTED_REVIEWERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" | jq -r '.users[].login')
          
          APPROVED_REVIEWERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" | \
            jq -r 'group_by(.user.login) | map(sort_by(.submitted_at) | last) | map(select(.state=="APPROVED")) | .[].user.login')

          echo "$APPROVED_REVIEWERS"

          # Check if all requested reviewers have approved
          for reviewer in $REQUESTED_REVIEWERS; do
            if ! echo "$APPROVED_REVIEWERS" | grep -q "$reviewer"; then
              echo "❌ Merge is invalid! Required reviewer @$reviewer has NOT approved."
              exit 1
            fi
          done
          
          echo "✅ All tagged reviewers have approved. Merge is valid."
