name: "Enforce Required Approvals"

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - review_requested
      - review_request_removed
      - ready_for_review
  pull_request_review:
    types:
      - submitted
      - dismissed

jobs:
  enforce-approvals:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      checks: write
      statuses: write

    steps:
      - name: Get PR Review Information
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          REPO="${{ github.repository }}"

          # Get list of requested reviewers
          REQUESTED_REVIEWERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/requested_reviewers" | jq -r '.users[].login')

          # Get latest approvals from reviewers
          APPROVED_REVIEWERS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/$REPO/pulls/$PR_NUMBER/reviews" | \
            jq -r 'group_by(.user.login) | map(sort_by(.submitted_at) | last) | map(select(.state=="APPROVED")) | .[].user.login')

          echo "üîç Requested Reviewers: $REQUESTED_REVIEWERS"
          echo "‚úÖ Approved Reviewers: $APPROVED_REVIEWERS"

          # If a review was re-requested, invalidate approval for that user
          if [[ "${{ github.event.action }}" == "review_requested" ]]; then
            REQUESTED_USER="${{ github.event.requested_reviewer.login }}"
            echo "üîÑ Review was re-requested for @$REQUESTED_USER. Removing approval."
            APPROVED_REVIEWERS=$(echo "$APPROVED_REVIEWERS" | grep -v "$REQUESTED_USER" || true)
          fi

          # Check if all requested reviewers have approved
          for reviewer in $REQUESTED_REVIEWERS; do
            if ! echo "$APPROVED_REVIEWERS" | grep -q "$reviewer"; then
              echo "‚ùå PR cannot be merged. Required reviewer @$reviewer has NOT approved."

              # üî¥ FAIL the status check
              curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github.v3+json" \
                "https://api.github.com/repos/$REPO/statuses/${{ github.sha }}" \
                -d '{"state": "failure", "context": "Enforce Required Approvals", "description": "Required reviewer @$reviewer has not approved."}'

              exit 1
            fi
          done

          echo "‚úÖ All required reviewers have approved."

          # üü¢ PASS the status check
          curl -s -X POST -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/statuses/${{ github.sha }}" \
            -d '{"state": "success", "context": "Enforce Required Approvals", "description": "All required reviewers have approved."}'
